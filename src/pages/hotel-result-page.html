<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<!-- <link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"> -->
<link rel="import" href="../../bower_components/app-route/app-route-converter.html">

<link rel="import" href="../../bower_components/t-filter/t-filter.html">
<link rel="import" href="../../bower_components/t-hotel-list/t-hotel-list.html">

<link rel="import" href="../../bower_components/t-progress-bar/t-progress-bar.html">
<link rel="import" href="../../bower_components/t-hotel-result-loader/t-hotel-result-loader.html">
<link rel="import" href="../../bower_components/t-component-api/t-component-api.html">


<link rel="import" href="../mixin/t-hotel-result-mixin.html">

<link rel="import" href="../nxt-shared-styles.html">


<dom-module id="hotel-result-page">
  <template>
    <style include="nxt-shared-styles">
      .preloader-content {
        min-height: 200px;
        padding: 50px 20px 0px 0px;
      }

      t-filter {
        width: 100%;
        display: none;
      }

      t-hotel-list {
        width: 100%;
      }

      @media screen and (min-width: 1025px) {
        t-filter {
          width: 290px;
          display: block;
          float: left;
        }
        t-hotel-list {
          margin-left: 24px;
          width: calc(100% - 318px);
          float: left;
        }
        .container {
          margin: auto 20px;
        }
      }

      @media screen and (max-width: 1024px) {
        t-filter {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          z-index: 100;
          padding: 0;
        }
      }

      .clearfix {
        clear: both;
      }
    </style>

    <app-route route="{{route}}" data="{{routeData}}">
    </app-route>

    <div class="container">
      <template is="dom-if" if="[[isPreloader]]">
        <t-progress-bar value="[[progressValue]]" text="LOADING YOUR RESULTS"></t-progress-bar>

        <t-hotel-result-loader data="[[loaderFilterData]]">
        </t-hotel-result-loader>
      </template>

      <template is="dom-if" if="[[isResultLoaded]]">


        <t-filter id="tFilter" on-t-filter-changed="_onFilterChange" data="[[filterData]]" settings="[[filterSettings]]" resources="[[filterResources]]">
        </t-filter>

        <t-hotel-list on-t-list-filter-updated="_onFilterUpdateFromResult" support-number="[[supportNumber]]" filters="{{filterData}}" items="[[resultItems]]" settings="[[resultSettings]]" resources="[[resultResources]]" on-t-hotel-item-show-details-tap="_redirectToHotelDetails" on-t-hotel-item-title-tap="_redirectToHotelDetails">

          <!-- template to render when no data is present-->
          <!-- Styling and content is not part of t-list component, should be done by consumer.-->
          <span slot="noresults">
              <div>{{resources.noResultsFound}}</div>
              <div>Try a new search</div>
              <!--<t-search></t-search>-->
          </span>
        </t-hotel-list>

        <div class="clearfix"></div>

      </template>
    </div>
    <!--<iron-ajax auto url="/src/mock/result.json" handle-as="json" last-response="{{resultRS}}" on-response="_onResultLoaded"></iron-ajax>
    <iron-ajax auto url="/src/mock/filter.json" handle-as="json" last-response="{{filterRS}}" on-response="_onFilterDataLoaded"></iron-ajax>-->
    <t-component-api id="ajaxHotelResult" url="{{apiBaseUrl}}/api/hotel/search/result" response="{{searchResult}}" on-api-success="_onResultLoaded"></t-component-api>
    <t-component-api id="ajaxFilterData" url="{{apiBaseUrl}}/api/hotel/search/result/filterdata/[[searchId]]" response="{{filterDataRS}}" on-api-success="_onFilterDataLoaded"></t-component-api>
    <!-- <iron-ajax id="ajaxHotelResult" url="{{apiBaseUrl}}/api/hotel/search/result" handle-as="json" last-response="{{searchResult}}"
      on-response="_onResultLoaded"></iron-ajax>
    <iron-ajax id="ajaxFilterData" url="{{apiBaseUrl}}/api/hotel/search/result/filterdata/[[searchId]]" handle-as="json" last-response="{{filterDataRS}}"
      on-response="_onFilterDataLoaded"></iron-ajax> -->

  </template>

  <script>var HotelResultPage = function (_THotelResultMixin) {
  babelHelpers.inherits(HotelResultPage, _THotelResultMixin);

  function HotelResultPage() {
    babelHelpers.classCallCheck(this, HotelResultPage);
    return babelHelpers.possibleConstructorReturn(this, (HotelResultPage.__proto__ || Object.getPrototypeOf(HotelResultPage)).apply(this, arguments));
  }

  babelHelpers.createClass(HotelResultPage, [{
    key: '_onActivePageChanged',
    value: function _onActivePageChanged(isActivePage) {

      if (isActivePage && this._isNewSearch) {
        this._init();
        setTimeout(function () {
          this._onPageLoad();
        }.bind(this), 16);
      }
    }
  }, {
    key: '_onPageLoad',
    value: function _onPageLoad(pageModel) {
      if (pageModel) {
        this.searchCriteria = pageModel;
      }

      this.set("searchId", this.subroute.__queryParams.sid || "null");

      this.set("resultResources", this.getResultResource());
      this.set("resultSettings", this.getResultSetting());

      this._loadResult();

      this.set("filterResources", this.getFilterResources());
      this.set("filterSettings", this.getFiterSettings());

      this.__progressInterval = setInterval(this.__progressIncrement.bind(this), 200);
    }
  }, {
    key: 'ready',
    value: function ready() {
      babelHelpers.get(HotelResultPage.prototype.__proto__ || Object.getPrototypeOf(HotelResultPage.prototype), 'ready', this).call(this);
      // this.addEventListener("t-hotel-item-show-details-tap", e=>this._redirectToHotelDetails(e));
    }
  }, {
    key: '_init',
    value: function _init() {
      this.isResultLoaded = false;
      this.isPreloader = true;
      this.pageLoader = false;
      this.resultItems = null;
      this.filterData = null;
      this.progressValue = 0;
    }
  }, {
    key: '__progressIncrement',
    value: function __progressIncrement() {

      if (this.progressValue < 95) {
        this.progressValue += 1;
      }
    }
  }, {
    key: '_loadResult',
    value: function _loadResult() {
      this.$.ajaxHotelResult.request = {
        "searchId": this.searchId
      };
      this.$.ajaxHotelResult.triggerAjax();
    }
  }, {
    key: '_loadFilterData',
    value: function _loadFilterData() {

      this.$.ajaxFilterData.method = "GET";
      this.$.ajaxFilterData.triggerAjax();
    }
  }, {
    key: '_onFilterUpdateFromResult',
    value: function _onFilterUpdateFromResult() {
      console.log("_onFilterUpdateFromResult", this.filterData);
      var cloned = this._clone(this.filterData);
      this.filterData = [];
      this.filterData = cloned;
    }
  }, {
    key: '_clone',
    value: function _clone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }
  }, {
    key: '_onResultLoaded',
    value: function _onResultLoaded(evt) {

      this._loadFilterData();

      this.set("resultItems", this.searchResult.hotels);

      this.set("isResultLoaded", true);
      this.set("isPreloader", false);
      clearInterval(this.__progressInterval);

      this.set("pageLoader", false);
    }
  }, {
    key: '_onFilterDataLoaded',
    value: function _onFilterDataLoaded(evt) {

      this.set("filterData", this.getFilterSection(this.filterDataRS, "US"));
      var tFilter = this.shadowRoot.querySelector("#tFilter");
      tFilter && tFilter.init();
    }
  }, {
    key: '_onFilterChange',
    value: function _onFilterChange(evt, filterData) {
      console.log("filter changed");
      this.filterData = [];
      this.filterData = filterData;
    }
  }, {
    key: '_redirectToHotelDetails',
    value: function _redirectToHotelDetails(e) {
      e.stopPropagation();
      console.log("hotel details", e);
      this.dispatchEvent(new CustomEvent("page-redirect", {
        detail: {
          url: '/hotel-details?sid=' + this.searchId + '&hid=' + e.detail.id,
          routeModel: e.detail
        },
        bubbles: true,
        composed: true
      }));
    }
  }, {
    key: '_isNewSearch',
    get: function get() {
      return this.searchId !== this.subroute.__queryParams.sid || !this.resultItems && !this.filterData;
    }
  }], [{
    key: 'is',
    get: function get() {
      return 'hotel-result-page';
    }
  }, {
    key: 'properties',
    get: function get() {
      return {

        pageModel: Object,
        route: String,
        isPreloader: {
          type: Boolean,
          value: true
        },
        progressValue: {
          type: Number,
          value: 2
        },
        isResultLoaded: Boolean,

        searchCriteria: {
          type: Object
        },

        filterDataRS: Object,

        filterData: {
          type: Array,
          value: []
        },
        loaderFilterData: {
          type: Array,
          value: function value() {
            return this.getFilterSection({}, "US");
          }
        },
        supportNumber: String,
        apiBaseUrl: {
          type: String,
          value: ''

          // resultResources: Object,
          // resultItems: Object,
          // resultSettings: Object
        } };
    }
  }]);
  return HotelResultPage;
}(THotelResultMixin(Polymer.Element));

window.customElements.define(HotelResultPage.is, HotelResultPage);</script>
</dom-module>